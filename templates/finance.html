<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="container-fluid mt-3">
    <div class="row mb-4">
        <div class="col-6">
            <div class="card bg-success text-white p-3">
                <small>Kirim</small>
                <h4 id="total-income">0</h4>
            </div>
        </div>
        <div class="col-6">
            <div class="card bg-danger text-white p-3">
                <small>Chiqim</small>
                <h4 id="total-expense">0</h4>
            </div>
        </div>
    </div>

    <div class="card p-3 mb-4">
        <h5>Moliya balansi</h5>
        <canvas id="financeChart" style="max-height: 250px;"></canvas>
    </div>

    <div class="card p-3">
        <h5>Oxirgi amallar</h5>
        <div id="finance-list" class="list-group list-group-flush">
            </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    loadFinanceStats();
    loadFinanceHistory();
});

// 1. Statistika va Grafikni yuklash
async function loadFinanceStats() {
    try {
        const res = await fetch('/api/finance/stats');
        const stats = await res.json();
        
        document.getElementById('total-income').innerText = stats.income.toLocaleString() + " so'm";
        document.getElementById('total-expense').innerText = stats.expense.toLocaleString() + " so'm";

        // Grafikni chizish
        const ctx = document.getElementById('financeChart').getContext('2d');
        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Kirim', 'Chiqim'],
                datasets: [{
                    data: [stats.income, stats.expense],
                    backgroundColor: ['#28a745', '#dc3545'],
                    borderWidth: 0
                }]
            },
            options: {
                plugins: {
                    legend: { position: 'bottom' }
                }
            }
        });
    } catch (err) {
        console.error("Statistika yuklashda xato:", err);
    }
}

// 2. Tarixni yuklash
async function loadFinanceHistory() {
    try {
        const res = await fetch('/api/finance');
        const data = await res.json();
        const list = document.getElementById('finance-list');
        list.innerHTML = '';

        data.forEach(item => {
            const color = item.type === 'income' ? 'text-success' : 'text-danger';
            const sign = item.type === 'income' ? '+' : '-';
            
            list.innerHTML += `
                <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                    <div>
                        <div class="fw-bold">${item.category}</div>
                        <small class="text-muted">${item.date}</small>
                    </div>
                    <div class="${color} fw-bold">
                        ${sign} ${item.amount.toLocaleString()}
                    </div>
                </div>
            `;
        });
    } catch (err) {
        console.error("Tarixni yuklashda xato:", err);
    }
}
</script>
